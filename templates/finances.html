{% extends "base.html" %}

{% block title %}My Finances - BudgetBuddy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i data-feather="dollar-sign"></i>
        My Finances
    </h1>
    <div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
            <i data-feather="plus"></i>
            Add Account
        </button>
        <a href="{{ url_for('upload') }}" class="btn btn-outline-primary ms-2">
            <i data-feather="upload"></i>
            Import Transactions
        </a>
    </div>
</div>

<!-- Financial Summary Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card text-center gradient-card-1 h-100">
            <div class="card-body">
                <h5 class="card-title text-white">Net Worth</h5>
                <h2 class="text-white {% if net_worth >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ${{ "%.2f"|format(net_worth) }}
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center gradient-card-2 h-100">
            <div class="card-body">
                <h5 class="card-title text-white">Cash & Checking</h5>
                <h2 class="text-white">
                    ${{ "%.2f"|format(cash_total) }}
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center gradient-card-3 h-100">
            <div class="card-body">
                <h5 class="card-title text-white">Credit Cards</h5>
                <h2 class="text-white">
                    ${{ "%.2f"|format(credit_cards_total) }}
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center gradient-card-4 h-100">
            <div class="card-body">
                <h5 class="card-title text-white">Savings & Investments</h5>
                <h2 class="text-white">
                    ${{ "%.2f"|format(savings_total + investments_total) }}
                </h2>
            </div>
        </div>
    </div>
</div>

<!-- Master Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i data-feather="filter"></i>
            Filters
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="account-type-filter" class="form-label">Account Type</label>
                <select class="form-select" id="account-type-filter">
                    <option value="all">All Account Types</option>
                    <option value="checking">Checking</option>
                    <option value="savings">Savings</option>
                    <option value="credit_card">Credit Card</option>
                    <option value="investment">Investment</option>
                    <option value="loan">Loan</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="transaction-category-filter" class="form-label">Transaction Category</label>
                <select class="form-select" id="transaction-category-filter">
                    <option value="all">All Categories</option>
                    <option value="uncategorized">Uncategorized</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="date-range-filter" class="form-label">Date Range</label>
                <select class="form-select" id="date-range-filter">
                    <option value="all">All Time</option>
                    <option value="7days">Last 7 Days</option>
                    <option value="30days" selected>Last 30 Days</option>
                    <option value="90days">Last 3 Months</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="transaction-type-filter" class="form-label">Transaction Type</label>
                <select class="form-select" id="transaction-type-filter">
                    <option value="all">All Types</option>
                    <option value="expense">Expenses</option>
                    <option value="income">Income</option>
                </select>
            </div>
            
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="apply-filters">
                    <i data-feather="search"></i>
                    Apply Filters
                </button>
            </div>
        </div>
        
        <!-- Custom Date Range (initially hidden) -->
        <div class="row mt-3" id="custom-date-range" style="display: none;">
            <div class="col-md-3">
                <label for="date-from" class="form-label">From Date</label>
                <input type="date" class="form-control" id="date-from">
            </div>
            <div class="col-md-3">
                <label for="date-to" class="form-label">To Date</label>
                <input type="date" class="form-control" id="date-to">
            </div>
        </div>
        
        <!-- Advanced Filters (initially hidden) -->
        <div class="row mt-3" id="advanced-filters" style="display: none;">
            <div class="col-md-3">
                <label for="amount-min" class="form-label">Min Amount</label>
                <input type="number" class="form-control" id="amount-min" placeholder="0.00" step="0.01">
            </div>
            <div class="col-md-3">
                <label for="amount-max" class="form-label">Max Amount</label>
                <input type="number" class="form-control" id="amount-max" placeholder="0.00" step="0.01">
            </div>
            <div class="col-md-4">
                <label for="description-search" class="form-label">Search Description</label>
                <input type="text" class="form-control" id="description-search" placeholder="Search terms...">
            </div>
        </div>
        
        <div class="text-center mt-3">
            <button class="btn btn-sm btn-link" id="toggle-advanced-filters">
                <span class="more-filters"><i data-feather="chevron-down"></i> Show Advanced Filters</span>
                <span class="less-filters" style="display:none;"><i data-feather="chevron-up"></i> Hide Advanced Filters</span>
            </button>
        </div>
        
        <!-- Quick Filter Buttons -->
        <div class="d-flex flex-wrap gap-2 mt-3 pt-3 border-top">
            <button class="btn btn-sm btn-outline-secondary quick-filter" data-filter="recent">
                <i data-feather="clock"></i> Recent
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter" data-filter="high-value">
                <i data-feather="trending-up"></i> High Value (>$100)
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter" data-filter="uncategorized">
                <i data-feather="tag"></i> Uncategorized
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter" data-filter="food">
                <i data-feather="coffee"></i> Food & Dining
            </button>
            <button class="btn btn-sm btn-outline-secondary quick-filter" data-filter="shopping">
                <i data-feather="shopping-bag"></i> Shopping
            </button>
            <button class="btn btn-sm btn-outline-danger quick-filter" data-filter="reset">
                <i data-feather="x"></i> Reset All
            </button>
        </div>
    </div>
</div>

<!-- Accounts Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i data-feather="credit-card"></i>
            My Accounts
        </h5>
        <div>
            <button class="btn btn-sm btn-outline-secondary" id="collapse-all-accounts">
                <i data-feather="minus-square"></i>
                Collapse All
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="expand-all-accounts">
                <i data-feather="plus-square"></i>
                Expand All
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="accordion" id="accountsAccordion">
            {% if accounts %}
                {% for account in accounts %}
                <div class="accordion-item account-item" data-account-id="{{ account.id }}" data-account-type="{{ account.account_type }}">
                    <h2 class="accordion-header" id="account-heading-{{ account.id }}">
                        <button class="accordion-button {{ '' if loop.index == 1 else 'collapsed' }}" type="button" data-bs-toggle="collapse" data-bs-target="#account-collapse-{{ account.id }}">
                            <div class="d-flex justify-content-between w-100 align-items-center">
                                <div>
                                    <span class="fw-bold">{{ account.name }}</span>
                                    <span class="badge bg-secondary ms-2">{{ account.account_type|title }}</span>
                                </div>
                                <h5 class="mb-0 text-{{ 'success' if account.balance >= 0 else 'danger' }}">
                                    ${{ "%.2f"|format(account.balance) }}
                                </h5>
                            </div>
                        </button>
                    </h2>
                    <div id="account-collapse-{{ account.id }}" class="accordion-collapse collapse {{ 'show' if loop.index == 1 else '' }}" data-bs-parent="#accountsAccordion">
                        <div class="accordion-body p-0">
                            <!-- Account Details & Actions -->
                            <div class="d-flex justify-content-between align-items-center p-3">
                                <div class="account-details">
                                    <small class="text-muted">Created: {{ account.created_at.strftime('%m/%d/%Y') }}</small>
                                    <span class="mx-2">|</span>
                                    <span class="badge bg-{{ 'success' if account.is_active else 'danger' }}">
                                        {{ 'Active' if account.is_active else 'Inactive' }}
                                    </span>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary edit-account" data-account-id="{{ account.id }}">
                                        <i data-feather="edit-2"></i>
                                        Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-account" data-account-id="{{ account.id }}" data-account-name="{{ account.name }}">
                                        <i data-feather="trash-2"></i>
                                        Delete
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Transaction Quick Add -->
                            <div class="px-3 pb-3">
                                <button class="btn btn-sm btn-success add-transaction-btn" data-account-id="{{ account.id }}">
                                    <i data-feather="plus"></i> Add Transaction
                                </button>
                            </div>
                            
                            <!-- Account Transactions Table -->
                            <div class="transactions-container" id="transactions-{{ account.id }}">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Loading transactions...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i data-feather="credit-card" class="text-muted mb-3" style="width: 64px; height: 64px;"></i>
                    <h4>No Accounts Yet</h4>
                    <p class="text-muted">Add your first account to start tracking your finances.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                        <i data-feather="plus"></i>
                        Add Your First Account
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="plus"></i>
                    Add New Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_account') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Account Name</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="e.g., Chase Checking" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="account_type" class="form-label">Account Type</label>
                        <select class="form-select" id="account_type" name="account_type" required>
                            <option value="">Choose account type...</option>
                            <option value="checking">Checking</option>
                            <option value="savings">Savings</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="investment">Investment</option>
                            <option value="loan">Loan</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="balance" class="form-label">Current Balance</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="balance" name="balance" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-text">Enter the current balance of this account</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="plus"></i>
                        Add Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Account Modal -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="edit-2"></i>
                    Edit Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_account') }}">
                <input type="hidden" id="edit_account_id" name="account_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Account Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_account_type" class="form-label">Account Type</label>
                        <select class="form-select" id="edit_account_type" name="account_type" required>
                            <option value="checking">Checking</option>
                            <option value="savings">Savings</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="investment">Investment</option>
                            <option value="loan">Loan</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_balance" class="form-label">Current Balance</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="edit_balance" name="balance" step="0.01">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active" value="1">
                            <label class="form-check-label" for="edit_is_active">
                                Account is active
                            </label>
                            <div class="form-text">Inactive accounts won't appear in transaction dropdowns</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i data-feather="alert-triangle"></i>
                    Delete Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('delete_account') }}">
                <input type="hidden" id="delete_account_id" name="account_id">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>Warning:</strong> This action cannot be undone!
                    </div>
                    
                    <p>Are you sure you want to delete the account "<span id="delete_account_name" class="fw-bold"></span>"?</p>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> All transactions associated with this account will also be permanently deleted.
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirm_delete" class="form-label">Type "DELETE" to confirm:</label>
                        <input type="text" class="form-control" id="confirm_delete" name="confirm_delete" 
                               placeholder="Type DELETE to confirm" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="confirm_delete_btn" disabled>
                        <i data-feather="trash-2"></i>
                        Delete Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="plus"></i>
                    Add New Transaction
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="add-transaction-form">
                <div class="modal-body">
                    <input type="hidden" id="transaction_account_id" name="account_id">
                    
                    <div class="mb-3">
                        <label for="transaction_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="transaction_date" name="date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="transaction_description" name="description" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="transaction_amount" name="amount" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_type" class="form-label">Type</label>
                        <select class="form-select" id="transaction_type" name="transaction_type" required>
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_category" class="form-label">Category</label>
                        <select class="form-select" id="transaction_category" name="category_id">
                            <option value="">Uncategorized</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_merchant" class="form-label">Merchant (Optional)</label>
                        <input type="text" class="form-control" id="transaction_merchant" name="merchant">
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="transaction_notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save"></i>
                        Save Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Categorization Modal -->
<div class="modal fade" id="bulkCategorizeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="tag"></i>
                    Categorize Transactions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="bulk_category" class="form-label">Assign to Category</label>
                    <select class="form-select" id="bulk_category">
                        <option value="">Select category...</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="alert alert-info">
                    <span id="selected-transactions-count">0</span> transactions selected
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-bulk-categorize">
                    <i data-feather="check"></i>
                    Confirm Categorization
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Suggestions Modal -->
<div class="modal fade" id="aiSuggestionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="star"></i>
                    AI Category Suggestions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Suggestions will be loaded here -->
                <div id="ai-suggestions-container">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Generating suggestions...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" id="accept-all-suggestions">
                    <i data-feather="check-circle"></i>
                    Accept All
                </button>
                <button type="button" class="btn btn-success" id="apply-suggestions">
                    <i data-feather="check"></i>
                    Apply Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/finances.js') }}"></script>
{% endblock %} 